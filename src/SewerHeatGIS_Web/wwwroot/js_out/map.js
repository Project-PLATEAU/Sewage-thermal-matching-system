var Y=(l=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(l,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):l)(function(l){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+l+'" is not supported')});var t={settings:{zoom:18,center:[134.6853859,34.8151693],chiki:"\u5175\u5EAB\u770C",layerNameBuildingLod0:"BUILDING_LOD0_WGS84",layerNameBuildingLod1:"BUILDING_LOD1_WGS84",fieldNameBuildingKey:"gen_\u5EFA\u7269ID",layerNameDrainPipe:"DRAIN_PIPE_WGS84",fieldNameDrainPipeKey:"SEQNO",layerNameManhole:"MANHOLE_WGS84",fieldNameManholeKey:"SEQNO",fieldNameDiameterW:"DIAMETER_W",fieldNameSecDist:"SEC_DIST",fieldNameConstYear:"CONST_YEAR",fieldNameArea:"TR_AREA",fieldNameAreaNames:[{Name:"\u4E2D\u90E8\u51E6\u7406\u533A",Value:3},{Name:"\u5927\u5869\u51E6\u7406\u533A",Value:1},{Name:"\u6771\u90E8\u51E6\u7406\u533A",Value:2},{Name:"\u63D6\u4FDD\u5DDD\u51E6\u7406\u533A",Value:7},{Name:"\u5922\u524D\u51E6\u7406\u533A",Value:8},{Name:"\u9999\u5BFA\u51E6\u7406\u533A",Value:9},{Name:"\u5B89\u5BCC\u51E6\u7406\u533A",Value:10},{Name:"\u5BB6\u5CF6\u51E6\u7406\u533A",Value:11},{Name:"-",Value:0}],fieldNameBldgStoreysAboveGround:"bldg_storeysAboveGround",fieldNameBldgStoreysBelowGround:"bldg_storeysBelowGround",fieldNameBldgMeasuredHeight:"bldg_measuredHeight",fieldNameBldgUsage:"bldg_usage",fieldNameMaterial:"MATERIAL",fieldNameDiameter:"DIAMETER",fieldNameFclass:"FCLASS",fieldNameDepth:"DEPTH",fieldName3dGaikeiH:"GAIKEI_H",fieldName3dGaikeiW:"GAIKEI_W ",fieldName3dGaikeiS:"GAIKEI_S",fieldName3dGaikeiL:"GAIKEI_L",fieldName3dDepth:"DEPTH",fieldName3dAngle:"ANGLE"},state:{chiku:null,heatType:null,reportData:{selectedBuildingKey:null,youto:null,nobeyuka:null,reHeatDem:null,selectedDrainPipeKey:null,diameterW:null,secDist:null,potentialS:null,potentialW:null,potentialY:null,constYear:null,selectedDrainPipeCenter:null,heatPumpPolygon:null,heatPumpSizeStr:null,heatPumpWidth:null,heatPumpDepth:null,heatPumpHight:null,pipeLength:null}},constants:{maxZoom:22,minZoom:14,graphicLineLayerName:"Graphic_Line",graphicLineColor:"red",graphicLineWidth:3,graphicTextLayerName:"Graphic_Text",graphicTextColor:"red",graphicTextSize:12,graphicTextOffset:8,labelTextColor:"red",labelTextSize:9,labelMinScale:5e3,labelMaxScale:0,heatPumpLayerName:"Graphic_Cube",highlightHaloOpacity:.5,highlightFillOpacity:.2,sceneGroundOpacity:.6,sceneLayerMinScale:3e4,sceneLayerMaxScale:0,sceneDrainPipeColor:"blue",sceneManholeColor:"red",sceneHeatPumpColor:"rgb(255, 204, 255)",sceneHeatPumpOutlineColor:"black"},queryOutFields:{buildingLod0:{OBJECTID:"OBJECTID",SEQNO:null,Nobeyuka:"Nobeyuka",ReHeatDem3:"ReHeatDem3",ReHeatDem4:"ReHeatDem4",TmpKankyoKey:"tmpKankyoKey",NewYouto:"NewYouto",TR_AREA:null},drainPipe:{OBJECTID:"OBJECTID",SEQNO:null,SEC_DIST:null,DIAMETER_W:null,CONST_YEAR:null,TR_AREA:null,Potential_S:"Potential_S",Potential_W:"Potential_W",Potential_Y:"Potential_Y"},manhole:{OBJECTID:"OBJECTID",SEQNO:null,TR_AREA:null,Potential_S:"Potential_S",Potential_W:"Potential_W",Potential_Y:"Potential_Y"}},popupFields:{buildingLod0:{Nobeyuka:"Nobeyuka",bldg_storeysAboveGround:null,bldg_storeysBelowGround:null,bldg_measuredHeight:null,bldg_usage:null,HeatDemand1:"HeatDemand1",HeatDemand2:"HeatDemand2",HeatDemand3:"HeatDemand3",HeatDemand4:"HeatDemand4",ReHeatDem3:"ReHeatDem3",ReHeatDem4:"ReHeatDem4"},drainPipe:{MATERIAL:null,SEC_DIST:null,DIAMETER:null,Potential_S:"Potential_S",Potential_W:"Potential_W",Potential_Y:"Potential_Y"},manhole:{FCLASS:null,DEPTH:null,Potential_S:"Potential_S",Potential_W:"Potential_W",Potential_Y:"Potential_Y"}},initialize:function(){let l=this.settings;this.queryOutFields.buildingLod0.SEQNO=l.fieldNameBuildingKey,this.queryOutFields.buildingLod0.TR_AREA=l.fieldNameArea,this.queryOutFields.drainPipe.SEQNO=l.fieldNameDrainPipeKey,this.queryOutFields.drainPipe.SEC_DIST=l.fieldNameSecDist,this.queryOutFields.drainPipe.DIAMETER_W=l.fieldNameDiameterW,this.queryOutFields.drainPipe.CONST_YEAR=l.fieldNameConstYear,this.queryOutFields.drainPipe.TR_AREA=l.fieldNameArea,this.queryOutFields.manhole.SEQNO=l.fieldNameManholeKey,this.queryOutFields.manhole.TR_AREA=l.fieldNameArea,this.popupFields.buildingLod0.bldg_storeysAboveGround=l.fieldNameBldgStoreysAboveGround,this.popupFields.buildingLod0.bldg_storeysBelowGround=l.fieldNameBldgStoreysBelowGround,this.popupFields.buildingLod0.bldg_measuredHeight=l.fieldNameBldgMeasuredHeight,this.popupFields.buildingLod0.bldg_usage=l.fieldNameBldgUsage,this.popupFields.drainPipe.MATERIAL=l.fieldNameMaterial,this.popupFields.drainPipe.SEC_DIST=l.fieldNameSecDist,this.popupFields.drainPipe.DIAMETER=l.fieldNameDiameter,this.popupFields.manhole.FCLASS=l.fieldNameFclass,this.popupFields.manhole.DEPTH=l.fieldNameDepth}};t.initialize();async function y(l){return new Promise(e=>{Y(l,function(){let i=[];for(let s=0;s<arguments.length;s++)i.push(arguments[s]);e(i)})})}function m(l){let e=document.getElementById("errorMessage");e.querySelector("div[slot='message']").innerHTML=l,e.open=!0}function ce(l,e){return`<calcite-alert label="confirm" kind="brand" open="true">
                <div slot="title">${l}</div>
                <div slot="message">
                    <div class="row">
                        <div class="col-12 mt-2 mb-2">
                            ${e}
                        </div>
                        <div class="col-6">
                            <input type="submit" id="confirmSubmitButton" value="\u306F\u3044" class="esri-button">
                        </div>
                        <div class="col-6">
                            <input type="button" value="\u3044\u3044\u3048" class="esri-button esri-button--secondary">
                        </div>
                    </div>
                </div>
            </calcite-alert>`}function I(l,e,i,s=null){let n=document.getElementById("customConfirm");n.innerHTML="";let o=ce(l,e,i);n.innerHTML=o,n.querySelector("input[type='submit']").addEventListener("click",function(){try{s?i(s):i()}finally{n.innerHTML=""}}),n.querySelector("input[type='button']").addEventListener("click",function(){n.innerHTML=""})}function E(){document.getElementById("loading").classList.remove("d-none")}function S(){document.getElementById("loading").classList.add("d-none")}function N(l){return l??""}function w(l,e){return l==null?"":l.toFixed(e)}function k(l){l.classList.contains("d-none")?l.classList.remove("d-none"):l.classList.add("d-none")}var[ue,de,pe,he]=await y(["esri/Graphic","esri/layers/FeatureLayer","esri/layers/support/LabelClass","esri/geometry/Polygon"]),T=class{constructor(){this.kaokuActionElem=document.getElementById("matchingByKaokuAction"),this.kaokuBufferSizeElem=document.getElementById("kaokuBufferSize"),this.drainPipesActionElem=document.getElementById("matchingByDrainPipesAction"),this.manholeAndDrainPipesActionElem=document.getElementById("matchingByManholeAndDrainPipesAction"),this.manholeBufferSizeElem=document.getElementById("manholeBufferSize"),this.heatDemandLabel="'\u71B1\u9700\u8981\u5024:'",this.potentialLabel="'\u71B1\u30DD\u30C6\u30F3\u30B7\u30E3\u30EB\u5024:'",this.kuchouHeatDemandName="ReHeatDem3",this.kuchouHeatPotentialName="Potential_Y",this.kyutouHeatDemandName="ReHeatDem4",this.kyutouHeatPotentialName="Potential_Y",this.KankyoKeyName=t.queryOutFields.buildingLod0.TmpKankyoKey,this.MAX_BUFFER_SIZE=150,this.LABEL_SIGNIFICANT_DIGITS=2}async searchAndHighlight(e,i,s=[]){let n=await this.excuteSearch(e,i,s);return n?.length>0&&this.highlight(e,n),n}async highlight(e,i){let s=a.currentAction.name;await a.mapView.whenLayerView(e).then(async function(n){if(!a.currentAction||a.currentAction.name!==s)return[];for(let o of i){let r=o.getObjectId(),c=n.highlight(r);a.selectedFeatures.push({OBJECTID:o.attributes.OBJECTID,layerName:e.title,graphic:o,highlight:c})}})}async excuteSearch(e,i,s=[]){let n=a.currentAction.name;return await e.queryFeatures(i).then(async function(o){if(!a.currentAction||a.currentAction.name!==n)return[];let r=o.features;if(r.length===0)return m("\u691C\u7D22\u5BFE\u8C61\u304C0\u4EF6\u3067\u3057\u305F"),[];let c=[];for(let u of r){let d=u.getObjectId();s?.length>0&&!s.includes(d)||c.push(u)}return c.length===0?(m("\u691C\u7D22\u5BFE\u8C61\u304C0\u4EF6\u3067\u3057\u305F"),[]):c})}createBufferSearchQuery(e,i,s){let n=this.getBufferSearchWhereClause(e.title,i.graphic.attributes);if(!n)return null;let o=e.createQuery();return o.geometry=i.graphic.geometry,o.distance=s,o.units="meters",o.where=n,o.outFields=this.getOutFields(e.title),o}getBufferSearchWhereClause(e,i){let s=null;if(t.state.heatType===3){if(e===t.settings.layerNameBuildingLod0){let n=i[this.kuchouHeatPotentialName];n&&(s=n+" >= "+this.kuchouHeatDemandName)}else if(e===t.settings.layerNameDrainPipe){let n=i[this.kuchouHeatDemandName];n&&(s=this.kuchouHeatPotentialName+" >= "+n)}}else if(t.state.heatType===4){if(e===t.settings.layerNameBuildingLod0){let n=i[this.kyutouHeatPotentialName];n&&(s=n+" >= "+this.kyutouHeatDemandName)}else if(e===t.settings.layerNameDrainPipe){let n=i[this.kyutouHeatDemandName];n&&(s=this.kyutouHeatPotentialName+" >= "+n)}}return s}createAttributeSearchQuery(e,i){let s=e.createQuery();return s.where=this.getAttributeSearchWhereClause(e.title,i),s.outFields=this.getOutFields(e.title),s}getAttributeSearchWhereClause(e,i){let s="";if(e===t.settings.layerNameBuildingLod0){let n=i.filter(r=>t.state.heatType===3&&r.graphic.attributes[this.kuchouHeatPotentialName]>0||t.state.heatType===4&&r.graphic.attributes[this.kyutouHeatPotentialName]>0);if(n?.length===0)return s=this.KankyoKeyName+" = -1",s;let o=n.map(r=>r.graphic.attributes[t.settings.fieldNameDrainPipeKey]);s=this.KankyoKeyName+" in ("+o.join(",")+")",t.state.heatType===3?s+=" AND "+this.kuchouHeatDemandName+" > 0":t.state.heatType===4&&(s+=" AND "+this.kyutouHeatDemandName+" > 0")}return s}getOutFields(e){let i=null;return e===t.settings.layerNameBuildingLod0?i=["OBJECTID",t.queryOutFields.buildingLod0.TmpKankyoKey,this.kuchouHeatDemandName,this.kyutouHeatDemandName]:e===t.settings.layerNameDrainPipe?i=["OBJECTID",t.queryOutFields.drainPipe.SEQNO,this.kuchouHeatPotentialName,this.kyutouHeatPotentialName]:e===t.settings.layerNameManhole&&(i=["OBJECTID",this.kuchouHeatPotentialName,this.kyutouHeatPotentialName]),i}getLabelExpression(e){let i=null;return t.state.heatType===3?e===t.settings.layerNameBuildingLod0?i=this.heatDemandLabel+" + TextFormatting.NewLine + IIF(IsEmpty($feature."+this.kuchouHeatDemandName+"), '', Round($feature."+this.kuchouHeatDemandName+", "+this.LABEL_SIGNIFICANT_DIGITS+"))":e===t.settings.layerNameDrainPipe&&(i=this.potentialLabel+" + TextFormatting.NewLine + IIF(IsEmpty($feature."+this.kuchouHeatPotentialName+"), '', Round($feature."+this.kuchouHeatPotentialName+", "+this.LABEL_SIGNIFICANT_DIGITS+"))"):t.state.heatType===4&&(e===t.settings.layerNameBuildingLod0?i=this.heatDemandLabel+" + TextFormatting.NewLine + IIF(IsEmpty($feature."+this.kyutouHeatDemandName+"), '', Round($feature."+this.kyutouHeatDemandName+", "+this.LABEL_SIGNIFICANT_DIGITS+"))":e===t.settings.layerNameDrainPipe&&(i=this.potentialLabel+" + TextFormatting.NewLine + IIF(IsEmpty($feature."+this.kyutouHeatPotentialName+"), '', Round($feature."+this.kyutouHeatPotentialName+", "+this.LABEL_SIGNIFICANT_DIGITS+"))")),i}createLabelLayer(e,i,s,n){let o={type:s,color:[0,0,0,0],outline:null},r=this.getLabelExpression(i),c=new pe({symbol:{type:"text",color:t.constants.labelTextColor,haloSize:1,haloColor:"white",font:{size:t.constants.labelTextSize}},labelExpressionInfo:{expression:r},maxScale:t.constants.labelMaxScale,minScale:t.constants.labelMinScale}),u=[];for(let d of e){let p=d.geometry;i===t.settings.layerNameDrainPipe&&(p=he.fromExtent(p.extent));let g=new ue({geometry:p,attributes:d.attributes});u.push(g)}return new de({source:u,renderer:{type:"simple",symbol:o},fields:n,objectIdField:"OBJECTID",labelingInfo:c})}addBuildingLod0LabelLayer(e){let i=t.settings.layerNameBuildingLod0,s="simple-fill",n=[{name:"OBJECTID",type:"oid"},{name:this.kuchouHeatDemandName,type:"double"},{name:this.kyutouHeatDemandName,type:"double"}];a.buildingLod0LabelLayer=this.createLabelLayer(e,i,s,n),a.map.add(a.buildingLod0LabelLayer)}addDrainPipeLabelLayer(e){let i=t.settings.layerNameDrainPipe,s="simple-fill",n=[{name:"OBJECTID",type:"oid"},{name:this.kuchouHeatPotentialName,type:"double"},{name:this.kyutouHeatPotentialName,type:"double"}];a.drainPipeLabelLayer=this.createLabelLayer(e,i,s,n),a.map.add(a.drainPipeLabelLayer)}clearLabelLayers(){a.buildingLod0LabelLayer&&(a.map.remove(a.buildingLod0LabelLayer),a.buildingLod0LabelLayer=null),a.drainPipeLabelLayer&&(a.map.remove(a.drainPipeLabelLayer),a.drainPipeLabelLayer=null)}checkInvalidPotentialFeatures(e){let i=!0;for(let s of e)t.state.heatType===3?s.graphic.attributes[this.kuchouHeatPotentialName]&&(i=!1):t.state.heatType===4&&s.graphic.attributes[this.kyutouHeatPotentialName]&&(i=!1);return i}initializeActionByKaoku(){if(a.currentAction?.isProcessing)return;let e=this,i=t.settings.layerNameBuildingLod0,s=!1,n=!1,o=async()=>{if(a.selectedFeatures.length===0)return;a.setMapClickNoSelect();let c=a.selectedFeatures[0],u=a.drainPipeFeatureLayer,d=e.kaokuBufferSizeElem.value,p=e.createBufferSearchQuery(u,c,d);if(!c.graphic.attributes||!p){m("\u5BB6\u5C4B\u306E\u5C5E\u6027\u5024\u304C\u7121\u52B9\u306E\u305F\u3081\u691C\u7D22\u3067\u304D\u307E\u305B\u3093");return}e.addBuildingLod0LabelLayer([c.graphic]);let g=await e.searchAndHighlight(u,p);g?.length>0&&e.addDrainPipeLabelLayer(g)},r=()=>{e.clearLabelLayers(),a.clearMapClickHandleEvent()};a.setActionTool(this.kaokuActionElem,i,s,n,o,r)}initializeActionByDrainPipes(){if(a.currentAction?.isProcessing)return;let e=this,i=t.settings.layerNameDrainPipe,s=!0,n=!0,o=async c=>{e.clearLabelLayers(),a.removeLayerSelectedFeatures(t.settings.layerNameBuildingLod0);let u=a.selectedFeatures.filter(b=>b.layerName===t.settings.layerNameDrainPipe);if(u?.length===0){a.clearSelectedFeatures(),m("\u7BA1\u6E20\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044");return}if(e.checkInvalidPotentialFeatures(u)){m("\u7BA1\u6E20\u306E\u5C5E\u6027\u5024\u304C\u7121\u52B9\u306E\u305F\u3081\u691C\u7D22\u3067\u304D\u307E\u305B\u3093");return}e.addDrainPipeLabelLayer(u.map(b=>b.graphic));let p=a.buildingLod0FeatureLayer,g=e.createAttributeSearchQuery(p,u),L=await e.excuteSearch(p,g).then(b=>{let P=[];for(let D of b){let v,F;t.state.heatType===3?(v=D.attributes[e.kuchouHeatDemandName],F=e.kuchouHeatPotentialName):t.state.heatType===4&&(v=D.attributes[e.kyutouHeatDemandName],F=e.kyutouHeatPotentialName),u.filter(W=>W.graphic.attributes[F]!=null&&W.graphic.attributes[F]>=v)?.length>0&&P.push(D)}return P});if(L?.length>0)e.highlight(p,L),e.addBuildingLod0LabelLayer(L);else{m("\u691C\u7D22\u5BFE\u8C61\u304C0\u4EF6\u3067\u3057\u305F");return}},r=()=>{e.clearLabelLayers(),a.clearMapClickHandleEvent()};a.setActionTool(this.drainPipesActionElem,i,s,n,o,r)}initializeActionByManholeAndDrainPipes(){if(a.currentAction?.isProcessing)return;let e=this,i=[],s=t.settings.layerNameManhole,n=!1,o=!1,r=async()=>{e.clearLabelLayers(),a.removeLayerSelectedFeatures(t.settings.layerNameBuildingLod0);let d=a.selectedFeatures.filter(p=>p.layerName===t.settings.layerNameDrainPipe);if(d?.length>0){if(e.checkInvalidPotentialFeatures(d)){m("\u7BA1\u6E20\u306E\u5C5E\u6027\u5024\u304C\u7121\u52B9\u306E\u305F\u3081\u691C\u7D22\u3067\u304D\u307E\u305B\u3093");return}e.addDrainPipeLabelLayer(d.map(D=>D.graphic));let g=a.buildingLod0FeatureLayer,L=e.createAttributeSearchQuery(g,d),b=i.map(D=>D.attributes.OBJECTID),P=await e.searchAndHighlight(g,L,b);P?.length>0&&e.addBuildingLod0LabelLayer(P)}else m("\u7BA1\u6E20\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044")},c=async()=>{if(a.selectedFeatures.length===0)return;a.clearMapClickHandleEvent();let d=a.selectedFeatures[0],p=a.buildingLod0FeatureLayer,g=e.manholeBufferSizeElem.value,L=e.createBufferSearchQuery(p,d,g);if(!d.graphic.attributes||!L){m("\u4EBA\u5B54\u306E\u5C5E\u6027\u5024\u304C\u7121\u52B9\u306E\u305F\u3081\u691C\u7D22\u3067\u304D\u307E\u305B\u3093");return}i=await e.excuteSearch(p,L),a.setMapClickHandle(r,t.settings.layerNameDrainPipe,!0,!0)},u=()=>{i=[],e.clearLabelLayers(),a.clearMapClickHandleEvent()};a.setActionTool(this.manholeAndDrainPipesActionElem,s,n,o,c,u)}initialize(){this.kaokuBufferSizeElem.addEventListener("change",()=>{Math.sign(this.kaokuBufferSizeElem.value)!==1?this.kaokuBufferSizeElem.value=0:this.kaokuBufferSizeElem.value>this.MAX_BUFFER_SIZE&&(this.kaokuBufferSizeElem.value=this.MAX_BUFFER_SIZE)}),this.manholeBufferSizeElem.addEventListener("change",()=>{Math.sign(this.manholeBufferSizeElem.value)!==1?this.manholeBufferSizeElem.value=0:this.manholeBufferSizeElem.value>this.MAX_BUFFER_SIZE&&(this.manholeBufferSizeElem.value=this.MAX_BUFFER_SIZE)}),this.initializeActionByKaoku(),this.initializeActionByDrainPipes(),this.initializeActionByManholeAndDrainPipes()}},U=new T;var B=class{constructor(){this.elem=document.getElementById("editKankyoKeyAction"),this.TmpKankyoKeyName=t.queryOutFields.buildingLod0.TmpKankyoKey,this.KankyoKeyName=t.settings.fieldNameDrainPipeKey}async updateTempKankyoKey(){let e=a.selectedFeatures[0],s=a.selectedFeatures[1].graphic.attributes[this.KankyoKeyName];e.graphic.attributes[this.TmpKankyoKeyName]=s;let o=await a.getLayer(t.settings.layerNameBuildingLod0).applyEdits({updateFeatures:[e.graphic]})}initializeAction(){if(a.currentAction?.isProcessing)return;let e=this,i=t.settings.layerNameBuildingLod0,s=!1,n=!1,o=async()=>{await e.updateTempKankyoKey(),a.endAction()},r=u=>{a.clearMapClickHandleEvent(),a.setMapClickHandle(o,t.settings.layerNameDrainPipe)},c=()=>{a.clearMapClickHandleEvent()};a.setActionTool(this.elem,i,s,n,r,c)}initialize(){this.initializeAction()}},J=new B;var H=class{constructor(){this.elem=document.getElementById("editHeatDemandAction"),this.selectedKaokuFeature=null,this.modal=document.getElementById("editHeatDemandModal"),this.saveButton=document.getElementById("heatDemandSaveButton"),this.closeButton=document.getElementById("customCloseButton"),this.cancelButton=document.getElementById("heatDemandCancelButton"),this.editHeatDemandMessage=document.getElementById("editHeatDemandMessage"),this.denkiInput=document.getElementById("denki"),this.denkiRate=9.76,this.toshiGassInput=document.getElementById("toshiGass"),this.toshiGassRate=45,this.touyuInput=document.getElementById("touyu"),this.touyuRate=37,this.zyuuyuInput=document.getElementById("zyuuyu"),this.zyuuyuRate=41,this.ekikaSekiyuGasuInput=document.getElementById("ekikaSekiyuGass"),this.ekikaSekiyuGasuRate=50,this.taninKyoukyuInput=document.getElementById("taninKyoukyu"),this.taninKyoukyuRate=1.36}showModal(){this.modal.classList.remove("d-none")}closeModal(){this.resetModalValue(),this.modal.classList.add("d-none")}resetModalValue(){this.denkiInput.value=0,this.toshiGassInput.value=0,this.touyuInput.value=0,this.zyuuyuInput.value=0,this.ekikaSekiyuGasuInput.value=0,this.taninKyoukyuInput.value=0,this.selectedKaokuFeature=null,this.editHeatDemandMessage.innerHTML=""}calculateReHeatDem(){let e=this.denkiInput.value*this.denkiRate,i=this.toshiGassInput.value*this.toshiGassRate,s=this.touyuInput.value*this.touyuRate,n=this.zyuuyuInput.value*this.zyuuyuRate,o=this.ekikaSekiyuGasuInput.value*this.ekikaSekiyuGasuRate,r=this.taninKyoukyuInput.value*this.taninKyoukyuRate;return e+i+s+n+o+r}async updateReHeatDem(){let e=this.calculateReHeatDem();t.state.heatType===3?this.selectedKaokuFeature.attributes.ReHeatDem3=e:t.state.heatType===4&&(this.selectedKaokuFeature.attributes.ReHeatDem4=e);let s=await a.getLayer(t.settings.layerNameBuildingLod0).applyEdits({updateFeatures:[this.selectedKaokuFeature]})}checkInputs(){let e=null;return Math.sign(this.denkiInput.value)===-1?e="\u300C\u96FB\u6C17\u300D\u306B\u6B63\u3057\u3044\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044":Math.sign(this.toshiGassInput.value)===-1?e="\u300C\u90FD\u5E02\u30AC\u30B9\uFF0813A\uFF09\u300D\u306B\u6B63\u3057\u3044\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044":Math.sign(this.touyuInput.value)===-1?e="\u300C\u706F\u6CB9\u300D\u306B\u6B63\u3057\u3044\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044":Math.sign(this.zyuuyuInput.value)===-1?e="\u300C\u91CD\u6CB9\u300D\u306B\u6B63\u3057\u3044\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044":Math.sign(this.ekikaSekiyuGasuInput.value)===-1?e="\u300C\u6DB2\u5316\u77F3\u6CB9\u30AC\u30B9\uFF08LPG\uFF09\u300D\u306B\u6B63\u3057\u3044\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044":Math.sign(this.taninKyoukyuInput.value)===-1?e="\u300C\u4ED6\u4EBA\u304B\u3089\u4F9B\u7D66\u3055\u308C\u305F\u71B1\u300D\u306B\u6B63\u3057\u3044\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044":this.calculateReHeatDem()===0&&(e="\u3044\u305A\u308C\u304B\u306E\u9805\u76EE\u306B\u5024\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044"),e}async setSelectedFeature(){let e=this,i=a.getLayer(t.settings.layerNameBuildingLod0),s=a.selectedFeatures[0],n=i.createQuery();n.where="OBJECTID = "+s.OBJECTID,n.outFields=["OBJECTID",t.queryOutFields.buildingLod0.ReHeatDem3,t.queryOutFields.buildingLod0.ReHeatDem4],n.returnGeometry=!1,await i.queryFeatures(n).then(function(o){e.selectedKaokuFeature=o.features[0]})}initializeModal(){let e=this;this.saveButton.addEventListener("click",async function(){let i=e.checkInputs();if(i){e.editHeatDemandMessage.innerHTML=i;return}await e.updateReHeatDem(),a.endAction(),e.closeModal()}),this.closeButton.addEventListener("click",function(){a.endAction(),e.closeModal()}),this.cancelButton.addEventListener("click",function(){a.endAction(),e.closeModal()})}initializeAction(){if(a.currentAction?.isProcessing)return;let e=this,i=t.settings.layerNameBuildingLod0,s=!1,n=!1,o=async c=>{a.setMapClickNoSelect(),await e.setSelectedFeature(),e.showModal()},r=()=>{a.clearMapClickHandleEvent()};a.setActionTool(this.elem,i,s,n,o,r)}initialize(){this.initializeAction(),this.initializeModal()}},Q=new H;var[me,ye,ge]=await y(["esri/Graphic","esri/geometry/geometryEngine","esri/widgets/Sketch/SketchViewModel"]),O=class{constructor(){}addGraphicText(e){let i=Math.round(ye.geodesicLength(e,"meters")*10)/10;t.state.reportData.pipeLength=i.toFixed(1);let s={type:"text",color:t.constants.graphicTextColor,haloColor:"white",haloSize:"1px",text:t.state.reportData.pipeLength+" m",xoffset:t.constants.graphicTextOffset,yoffset:t.constants.graphicTextOffset,font:{size:t.constants.graphicTextSize,weight:"bold"}},n=new me({geometry:e.extent.center,symbol:s});a.graphicTextLayer.add(n)}addEventToSketchViewModel(){let e=this;a.sketchViewModel.on("create",function(i){i.state==="complete"&&(e.addGraphicText(i.graphic.geometry),a.endAction())}),a.sketchViewModel.on("update",function(i){if(a.graphicTextLayer.graphics.length&&(a.graphicTextLayer.removeAll(),t.state.reportData.pipeLength=null),i.aborted){a.sketchViewModel.delete();return}i.state==="complete"&&i.graphics.length>0&&e.addGraphicText(i.graphics[0].geometry)})}initializeSketchViewModel(){let e={type:"simple-line",color:t.constants.graphicLineColor,width:t.constants.graphicLineWidth};a.sketchViewModel=new ge({view:a.mapView,layer:a.graphicLineLayer,polylineSymbol:e}),this.addEventToSketchViewModel()}clearSketchViewModel(){a.sketchViewModel.layer.removeAll(),a.graphicTextLayer.removeAll(),t.state.reportData.pipeLength=null}initialize(){this.initializeSketchViewModel()}},A=new O;var[fe,Le]=await y(["esri/geometry/Polygon","esri/geometry/Mesh"]),C=class{constructor(){this.elem=document.getElementById("create3DPumpAction"),this.getHeatPumpSizeURL=`${appRoot}GetHeatPumpSize`}createHeatPump(){let e=t.state.reportData.heatPumpDepth/1e3,i=t.state.reportData.heatPumpWidth/1e3,s=t.state.reportData.heatPumpHight/1e3,n=t.state.reportData.selectedDrainPipeCenter,o=Le.createBox(n,{size:{width:i,depth:e,hight:s},units:"meters"});a.mapView.viewpoint.targetGeometry=n,a.mapView.zoom=t.constants.sceneZoom;let r=fe.fromExtent(o.extent);t.state.reportData.heatPumpPolygon=r,f.reset3dHeatPumpPosition()}async submit(e){t.state.reportData.heatPumpSizeStr||await e.getHeatPumpSize(),a.endAction(),e.createHeatPump();let i=document.getElementById("switchBtn");k(i),f.switchView();let s=()=>{};a.setAction(e.elem.id,s)}async getHeatPumpSize(){E();let e={HeatType:t.state.heatType,HeatDemand:t.state.reportData.reHeatDem,Potential:t.state.reportData.potentialY},i=new URLSearchParams(e).toString(),s=this.getHeatPumpSizeURL+"?"+i;await fetch(s).then(n=>{if(!n.ok)throw new Error(n.statusText);return n.json()}).then(n=>{var o=n.data.width,r=n.data.depth,c=n.data.hight;t.state.reportData.heatPumpSizeStr=`${o}*${r}*${c}`,t.state.reportData.heatPumpWidth=o,t.state.reportData.heatPumpDepth=r,t.state.reportData.heatPumpHight=c}).catch(n=>{m(`\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F<br>
                           \u30D2\u30FC\u30C8\u30DD\u30F3\u30D7\u30B5\u30A4\u30BA\u3092\u53D6\u5F97\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F `),console.error(n)}),S()}initializeAction(){if(a.currentAction?.isProcessing)return;let e=this;this.elem.addEventListener("click",function(){this.blur(),I("\u30D2\u30FC\u30C8\u30DD\u30F3\u30D7","\u30D2\u30FC\u30C8\u30DD\u30F3\u30D7\u3092\u914D\u7F6E\u3057\u307E\u3059\u304B",e.submit,e)})}initialize(){this.initializeAction()}},$=new C;var z=class{constructor(){this.elem=document.getElementById("createPipeLineAction")}initializeAction(){a.currentAction?.isProcessing||this.elem.addEventListener("click",function(){let e=a.currentAction?.name;if(a.endAction(),e===this.id)return;a.sketchViewModel.layer.graphics.length>0&&A.clearSketchViewModel(),a.sketchViewModel.create("polyline");let i=()=>{a.sketchViewModel.layer.graphics.length>0?a.sketchViewModel.delete():a.sketchViewModel.cancel()};a.setAction(this.id,i)})}initialize(){this.initializeAction()}},Z=new z;var[be,Pe,De]=await y(["esri/rest/print","esri/rest/support/PrintParameters","esri/rest/support/PrintTemplate"]),R=class{constructor(){this.excelId="downloadExcelAction",this.pdfId="downloadPdfAction",this.downloadExcelElem=document.getElementById(this.excelId),this.downloadPdfElem=document.getElementById(this.pdfId),this.downloadExcelUrl=`${appRoot}DownloadExcelTool`,this.downloadPdfUrl=`${appRoot}DownloadPdfTool`}checkReportData(){return t.state.reportData.heatPumpPolygon?t.state.reportData.pipeLength?!0:(a.sketchViewModel.layer.graphics.length>0?m("\u300C\u63A1\u71B1\u7D4C\u8DEF\u300D\u3092\u78BA\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044"):m("\u300C\u63A1\u71B1\u7D4C\u8DEF\u4F5C\u6210\u300D\u3092\u5B9F\u884C\u3057\u3066\u304F\u3060\u3055\u3044"),!1):(m("\u300C\u30D2\u30FC\u30C8\u30DD\u30F3\u30D7\u914D\u7F6E\u300D\u3092\u5B9F\u884C\u3057\u3066\u304F\u3060\u3055\u3044"),!1)}async downloadExcel(){E();let e={Chiki:t.settings.chiki,HeatType:t.state.heatType,Youto:t.state.reportData.youto,Nobeyuka:t.state.reportData.nobeyuka,PotentialY:t.state.reportData.potentialY,PipeLength:t.state.reportData.pipeLength},i=new URLSearchParams(e).toString(),s=this.downloadExcelUrl+"?"+i,n="001401606.xlsm";await fetch(s).then(o=>{if(!o.ok)throw new Error(o.statusText);let u=o.headers.get("Content-Disposition").split(";")[2].split("=")[1].split("'")[2].replaceAll('"',"");return n=decodeURI(u),o.blob()}).then(o=>{if(o!=null){var r=window.URL.createObjectURL(o),c=document.createElement("a");c.href=r,c.download=n,document.body.appendChild(c),c.click(),c.remove()}}).catch(o=>{m("\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F"),console.error(o)}),S()}async downloadPdf(){console.log("PDF\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9"),E();try{a.graphicsSelectionLayer.visible=!0;var e=a.mapView.rotation;a.mapView.rotation=0;let s="https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",n=be.execute(s,new Pe({view:a.mapView,template:new De({format:"PNG32",layout:"MAP_ONLY",exportOptions:{width:1200,height:1200*(.517751*210/(.93587*297))},scalePreserved:!1})})),o=new FormData,[r]=await Promise.all([n]);a.mapView.rotation=e,o.append("HeatType",t.state.heatType),o.append("BuildingID",N(t.state.reportData.selectedBuildingKey)),o.append("BuildingYouto",N(t.state.reportData.youto)),o.append("BuildingNobeyuka",w(t.state.reportData.nobeyuka,2)),o.append("BuildingReHeatDemand",w(t.state.reportData.reHeatDem,2)),o.append("BuildingHeatPumpSize",N(t.state.reportData.heatPumpSizeStr)),o.append("PipeID",N(t.state.reportData.selectedDrainPipeKey)),o.append("PipeDiameter",w(t.state.reportData.diameterW,2)),o.append("PipeSecDist",w(t.state.reportData.secDist,2)),o.append("PipePotentialS",w(t.state.reportData.potentialS,2)),o.append("PipePotentialW",w(t.state.reportData.potentialW,2)),o.append("PipePotentialY",w(t.state.reportData.potentialY,2)),o.append("PipeConstYear",N(t.state.reportData.constYear)),a.graphicsSelectionLayer.visible=!1,o.append("Url",r.url);let c=new Request(this.downloadPdfUrl,{method:"POST",body:o});var i="report.pdf";await fetch(c).then(u=>{if(!u.ok)throw new Error(u.statusText);let g=u.headers.get("Content-Disposition").split(";")[2].split("=")[1].split("'")[2].replaceAll('"',"");return i=decodeURI(g),u.blob()}).then(u=>{if(u!=null){var d=window.URL.createObjectURL(u),p=document.createElement("a");p.href=d,p.download=i,document.body.appendChild(p),p.click(),p.remove()}}).catch(u=>{m("\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F"),console.error(u)})}finally{S()}}initializeActionExcel(){if(a.currentAction?.isProcessing)return;let e=this;this.downloadExcelElem.addEventListener("click",async function(){if(a.endAction(),!e.checkReportData())return;let i=()=>{};a.setAction(e.excelId,i),await e.downloadExcel(),a.endAction()})}initializeActionPdf(){if(a.currentAction?.isProcessing)return;let e=this;this.downloadPdfElem.addEventListener("click",async()=>{if(a.endAction(),!e.checkReportData())return;let i=()=>{};a.setAction(e.pdfId,i);let s=await this.downloadPdf();a.endAction()})}initialize(){this.initializeActionExcel(),this.initializeActionPdf()}},X=new R;var V=class{constructor(){this.startReportModeElem=document.getElementById("startReportModeAction"),this.endReportModeElem=document.getElementById("endReportModeAction"),this.buildingKeyName=t.queryOutFields.buildingLod0.SEQNO,this.buildingNobeyukaName=t.queryOutFields.buildingLod0.Nobeyuka,this.buildingYoutoName=t.queryOutFields.buildingLod0.NewYouto,this.buildingReHeatDem3Name=t.queryOutFields.buildingLod0.ReHeatDem3,this.buildingReHeatDem4Name=t.queryOutFields.buildingLod0.ReHeatDem4,this.drainPipeKeyName=t.queryOutFields.drainPipe.SEQNO,this.drainPipeSecDistName=t.queryOutFields.drainPipe.SEC_DIST,this.drainPipeDiameterWName=t.queryOutFields.drainPipe.DIAMETER_W,this.drainPipeConstYearName=t.queryOutFields.drainPipe.CONST_YEAR,this.drainPipePotentialSName=t.queryOutFields.drainPipe.Potential_S,this.drainPipePotentialWName=t.queryOutFields.drainPipe.Potential_W,this.drainPipePotentialYName=t.queryOutFields.drainPipe.Potential_Y}reportModeStart(){a.ChangeMode("report"),a.refreshDisabledElems(),this.setAttributesBySelectedFeatures()}reportModeEnd(){a.graphicHeatPumpLayer.removeAll(),A.clearSketchViewModel(),a.clearSelectedFeatures(),a.clearMapClickHandleEvent(),a.ChangeMode("default"),f.clearReportData(),a.mapView.popup.autoOpenEnabled=!0,a.refreshDisabledElems()}setAttributesBySelectedFeatures(){let e;t.state.heatType===3?e=this.buildingReHeatDem3Name:t.state.heatType===4&&(e=this.buildingReHeatDem4Name);for(let i of a.selectedFeatures){if(i.layerName!==t.settings.layerNameBuildingLod0&&i.layerName!==t.settings.layerNameDrainPipe)return;i.layerName===t.settings.layerNameBuildingLod0?(t.state.reportData.selectedBuildingKey=i.graphic.attributes[this.buildingKeyName],t.state.reportData.nobeyuka=i.graphic.attributes[this.buildingNobeyukaName],t.state.reportData.youto=i.graphic.attributes[this.buildingYoutoName],t.state.reportData.reHeatDem=i.graphic.attributes[e]):i.layerName===t.settings.layerNameDrainPipe&&(t.state.reportData.selectedDrainPipeCenter=i.graphic.geometry.extent.center,t.state.reportData.selectedDrainPipeKey=i.graphic.attributes[this.drainPipeKeyName],t.state.reportData.potentialS=i.graphic.attributes[this.drainPipePotentialSName],t.state.reportData.potentialW=i.graphic.attributes[this.drainPipePotentialWName],t.state.reportData.potentialY=i.graphic.attributes[this.drainPipePotentialYName],t.state.reportData.constYear=i.graphic.attributes[this.drainPipeConstYearName],t.state.reportData.diameterW=i.graphic.attributes[this.drainPipeDiameterWName],t.state.reportData.secDist=i.graphic.attributes[this.drainPipeSecDistName])}}initializeActionStart(){if(a.currentAction?.isProcessing)return;let e=this;this.startReportModeElem.addEventListener("click",function(){if(a.mode==="default"){let o=a.currentAction?.name;if(a.endAction(),o===this.id){e.reportModeEnd();return}}else a.endAction(),e.reportModeEnd();let i=o=>{e.reportModeStart(),a.endAction()},s=o=>{a.clearMapClickHandleEvent(),a.setMapClickHandle(i,t.settings.layerNameDrainPipe)};a.setMapClickHandle(s,t.settings.layerNameBuildingLod0);let n=()=>{a.mode==="default"?a.clearMapClickHandleEvent():a.setMapClickNoSelect()};a.setAction(this.id,n)})}initializeActionEnd(){if(a.currentAction?.isProcessing)return;let e=this;this.endReportModeElem.addEventListener("click",function(){a.endAction(),e.reportModeEnd()})}initialize(){A.initialize(),this.initializeActionStart(),$.initialize(),Z.initialize(),X.initialize(),this.initializeActionEnd()}},ee=new V;var[we,Ee,M,Se,te,Ne,ke,Ae,ie,ae,Fe]=await y(["esri/WebMap","esri/views/MapView","esri/layers/GraphicsLayer","esri/widgets/Legend","esri/core/reactiveUtils","esri/portal/Portal","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/Color","esri/Graphic","esri/identity/IdentityManager"]),x=class{constructor(){}addDisabledElems(){let e=document.getElementsByClassName("canDisabled");for(let i=0;i<e.length;i++)(this.mode==="report"&&!e[i].closest("#reportModeLabel")||this.mode==="default"&&e[i].closest("#reportModeLabel"))&&(e[i].disabled=!0)}removeDisabledElems(){let e=document.getElementsByClassName("canDisabled");for(let i=0;i<e.length;i++)e[i].disabled=!1}refreshDisabledElems(){this.removeDisabledElems(),this.addDisabledElems()}setMapClickHandle(e,i,s=!1,n=!1){let o=this;this.mapClickHandle&&this.clearMapClickHandleEvent(),this.mapClickHandle=te.on(()=>o.mapView,"click",r=>{o.currentAction&&(o.currentAction.isProcessing=!0,o.mapView.hitTest(r,{include:a.getLayer(i)}).then(function(c){let u=c.results?.filter(d=>d.type==="graphic"&&d.layer.title===i);u?.length>0&&u.forEach((d,p)=>{!s&&p!==0||o.mapView.whenLayerView(d.graphic.layer).then(function(g){let L=d.graphic.attributes.OBJECTID,b=o.selectedFeatures?.filter(P=>P.OBJECTID===L);if(b.length===0){let P=g.highlight(d.graphic);o.selectedFeatures.push({OBJECTID:L,layerName:d.layer.title,graphic:d.graphic,highlight:P});let D=o.createSelectionGraphic(d.graphic.geometry);o.graphicsSelectionLayer.add(D)}else n&&o.removeSelectedFeatures(d.layer.title,b[0].OBJECTID);(!s&&p===0||u.length==p+1)&&(e(r),o.currentAction?.isProcessing&&(o.currentAction.isProcessing=!1))})})}))})}clearMapClickHandleEvent(){this.mapClickHandle&&(this.mapClickHandle.remove(),this.mapClickHandle=null)}setMapClickNoSelect(){this.clearMapClickHandleEvent(),this.setMapClickHandle(()=>{},"")}ChangeMode(e){e!==this.mode&&(this.mode=e)}setAction(e,i){this.mode==="default"&&this.clearPopupHighlight();let s=document.getElementById(e);s.classList.add("item-selected"),s.blur(),this.currentAction={name:e,isProcessing:!1,end:i},this.mapView.popup.autoOpenEnabled=!1}endAction(){if(!this.currentAction)return;let e=document.getElementById(this.currentAction.name);e.classList.remove("item-selected"),e.blur(),this.currentAction.end(),this.currentAction=null,this.mode==="default"&&(this.mapView.popup.autoOpenEnabled=!0,this.clearSelectedFeatures())}removeSelectedFeatures(e,i){let s=this.selectedFeatures.filter(n=>n.layerName===e&&n.OBJECTID===i);s?.length>0&&(s[0].highlight.remove(),this.selectedFeatures=this.selectedFeatures.filter(n=>n!==s[0]))}removeLayerSelectedFeatures(e){let s=this.selectedFeatures.filter(n=>n.layerName===e).map(n=>n.OBJECTID);for(let n of s)a.removeSelectedFeatures(e,n)}clearSelectedFeatures(){for(let e of this.selectedFeatures)e.highlight.remove();this.selectedFeatures=[],this.clearSelectionGraphic()}clearPopupHighlight(){this.mapView.popup.highlightEnabled=!1,this.mapView.popup.close(),this.mapView.popup.highlightEnabled=!0}createSelectionGraphic(e){if(e.type==="polygon"){let i=new ae({geometry:e,symbol:this.selectionFillSymbol});this.graphicsSelectionLayer.add(i)}else if(e.type==="polyline"){let i=new ae({geometry:e,symbol:this.selectionLineSymbol});this.graphicsSelectionLayer.add(i)}}clearSelectionGraphic(){this.graphicsSelectionLayer.removeAll()}setFeatureLayer(e){e.title===t.settings.layerNameBuildingLod0?this.buildingLod0FeatureLayer=e:e.title===t.settings.layerNameDrainPipe?this.drainPipeFeatureLayer=e:e.title===t.settings.layerNameManhole&&(this.manholeFeatureLayer=e)}getLayer(e){for(let i of this.map.layers)if(i.title===e)return i}setFeatureFilter(e){for(let i of this.map.layers)(i.title===t.settings.layerNameBuildingLod0||i.title===t.settings.layerNameDrainPipe||i.title===t.settings.layerNameManhole)&&(i.definitionExpression=t.settings.fieldNameArea+" = "+e)}addEventToPopup(){let e=this;te.watch(()=>e.mapView.popup.selectedFeature,()=>{e.currentAction&&e.clearPopupHighlight()})}addEventToChikuSelect(){if(this.currentAction?.isProcessing)return;let e=this,i=document.getElementById("chikuSelect");t.state.chiku=i.value,i.addEventListener("calciteSelectChange",function(){e.endAction(),t.state.chiku=this.value,f.setFeatureFilters(this.value)})}addEventToHeatTypeSelect(){if(this.currentAction?.isProcessing)return;let e=this,i=document.getElementById("heatTypeSelect");t.state.heatType=parseInt(i.value),i.addEventListener("calciteSelectChange",function(){e.endAction(),t.state.heatType=parseInt(this.value)})}setActionTool(e,i,s,n,o,r){let c=this;e.addEventListener("click",function(){let u=c.currentAction?.name;c.endAction(),u!==this.id&&(c.setMapClickHandle(o,i,s,n),c.setAction(this.id,r))})}initializeEvents(){this.addEventToPopup(),document.getElementById("control-signout").addEventListener("click",()=>{Fe.destroyCredentials(),window.location.reload()}),this.addEventToChikuSelect(),this.addEventToHeatTypeSelect(),U.initialize(),J.initialize(),Q.initialize(),ee.initialize()}initializeFilter(){if(t.settings.fieldNameAreaNames?.length===0)throw new Error("\u8A2D\u5B9A\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u51E6\u7406\u533A\u304C\u53C2\u7167\u3067\u304D\u307E\u305B\u3093\u3002");let e=t.settings.fieldNameAreaNames[0].Value;this.setFeatureFilter(e);let i=document.getElementById("chikuSelect"),s;for(let n of t.settings.fieldNameAreaNames)s?s+=`<calcite-option value="${n.Value}">${n.Name}</calcite-option>`:s=`<calcite-option value="${n.Value}" selected="">${n.Name}</calcite-option>`;i.innerHTML=s}initializePopup(){this.mapView.popup.dockOptions.buttonEnabled=!1;let e=this.buildingLod0FeatureLayer.popupTemplate.content[0].fieldInfos.filter(n=>Object.values(t.popupFields.buildingLod0).includes(n.fieldName));this.buildingLod0FeatureLayer.popupTemplate.content[0].fieldInfos=e,this.buildingLod0FeatureLayer.popupTemplate.title="\u5BB6\u5C4B";let i=this.drainPipeFeatureLayer.popupTemplate.content[0].fieldInfos.filter(n=>Object.values(t.popupFields.drainPipe).includes(n.fieldName));this.drainPipeFeatureLayer.popupTemplate.content[0].fieldInfos=i,this.drainPipeFeatureLayer.popupTemplate.title="\u7BA1\u6E20";let s=this.manholeFeatureLayer.popupTemplate.content[0].fieldInfos.filter(n=>Object.values(t.popupFields.manhole).includes(n.fieldName));this.manholeFeatureLayer.popupTemplate.content[0].fieldInfos=s,this.manholeFeatureLayer.popupTemplate.title="\u4EBA\u5B54"}initializeQuery(){this.buildingLod0FeatureLayer.outFields=Object.values(t.queryOutFields.buildingLod0),this.drainPipeFeatureLayer.outFields=Object.values(t.queryOutFields.drainPipe),this.manholeFeatureLayer.outFields=Object.values(t.queryOutFields.manhole)}initializeLegend(){let e=[{title:"\u5BB6\u5C4B",layer:this.buildingLod0FeatureLayer},{title:"\u7BA1\u6E20",layer:this.drainPipeFeatureLayer},{title:"\u4EBA\u5B54",layer:this.manholeFeatureLayer}],i=new Se({view:this.mapView,layerInfos:e});this.mapView.ui.add(i,"bottom-left")}initializeLayers(){for(let e of this.map.layers)e.type==="feature"&&this.setFeatureLayer(e);this.map.add(this.graphicHeatPumpLayer),this.map.add(this.graphicLineLayer),this.map.add(this.graphicTextLayer),this.map.add(this.graphicsSelectionLayer)}async initialize(){this.buildingLod0FeatureLayer=null,this.drainPipeFeatureLayer=null,this.manholeFeatureLayer=null,this.graphicLineLayer=new M({title:t.constants.graphicLineLayerName}),this.graphicTextLayer=new M({title:t.constants.graphicTextLayerName}),this.graphicHeatPumpLayer=new M({title:t.constants.heatPumpLayerName}),this.buildingLod0LabelLayer=null,this.drainPipeLabelLayer=null,this.selectedFeatures=[],this.sketchViewModel=null,this.mapClickHandle=null,this.mode="default",this.currentAction=null,this.mapView.highlightOptions.haloOpacity=t.constants.highlightHaloOpacity,this.mapView.highlightOptions.fillOpacity=t.constants.highlightFillOpacity,this.graphicsSelectionLayer=new M({title:"graphicsSelectionLayer",visible:!1});let e=this.mapView.highlightOptions.color;this.selectionLineSymbol=new Ae({style:"solid",color:new ie([e.r,e.g,e.b,this.mapView.highlightOptions.haloOpacity]),width:3}),this.selectionFillSymbol=new ke({style:"solid",outline:this.selectionLineSymbol,color:new ie([e.r,e.g,e.b,this.mapView.highlightOptions.fillOpacity])}),this.initializeLayers(),this.initializeLegend(),this.initializeQuery(),this.initializePopup(),this.initializeFilter(),this.initializeEvents(),this.addDisabledElems()}async init(){var e=new Ne;e.authMode="immediate",await e.load();let s={filter:'type:"Web Map" AND title:"'+"\u516C\u958B\u7528\u30DE\u30C3\u30D7"+'" NOT access:public'},n=await e.queryItems(s);if(n.results.length===0)throw new Error("ArcGIS Online\u304B\u3089\u516C\u958B\u7528\u30DE\u30C3\u30D7\u304C\u53C2\u7167\u3067\u304D\u307E\u305B\u3093\u3002");let o=new we({portalItem:{id:n.results[0].id}});this.map=o,this.mapView=new Ee({map:o,container:"mapViewDiv",center:t.settings.center,zoom:t.settings.zoom,constraints:{maxZoom:t.constants.maxZoom,minZoom:t.constants.minZoom}}),this.map.when(()=>{this.initialize()})}},a=new x;var _=class{constructor(){this.elem=document.getElementById("pumpSubmitAction")}submit(){let e=h.graphicCubeLayer.graphics.items[0].geometry.centroid;h.sceneView.viewpoint.targetGeometry=e,f.updateHeatPumpPolygon(h.graphicCubeLayer.graphics.items[0]);let i=document.getElementById("switchBtn");k(i),f.switchView()}initializeAction(){let e=this.submit;this.elem.addEventListener("click",function(){this.blur(),I("\u30D2\u30FC\u30C8\u30DD\u30F3\u30D7","\u914D\u7F6E\u3092\u6C7A\u5B9A\u3057\u307E\u3059\u304B",e)})}initialize(){this.initializeAction()}},ne=new _;var[Ie]=await y(["esri/widgets/Sketch/SketchViewModel"]),G=class{constructor(){}addEventToSketchViewModel(){h.sketchViewModel.on("delete",function(e){e.graphics.forEach(function(i){h.graphicCubeLayer.add(i)})})}initializeSketchViewModel(){h.scene.add(h.graphicCubeLayer),h.sketchViewModel=new Ie({view:h.sceneView,layer:h.graphicCubeLayer,defaultCreateOptions:{hasZ:!0},defaultUpdateOptions:{enableZ:!1,enableScaling:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1}}),this.addEventToSketchViewModel()}initialize(){this.initializeSketchViewModel()}},se=new G;var[Me,ve,Te,Be]=await y(["esri/WebScene","esri/views/SceneView","esri/layers/GraphicsLayer","esri/portal/Portal"]),K=class{constructor(){}getRenderer(e){let i="simple",s=this.getSymbol(e),n={type:i,symbol:s},o=this.getVisualVariables(e);return n.visualVariables=o,n}getSymbol(e){if(e===t.settings.layerNameDrainPipe)return{type:"line-3d",symbolLayers:[{type:"path",profile:"quad",material:{color:t.constants.sceneDrainPipeColor}}]};if(e===t.settings.layerNameManhole)return{type:"point-3d",symbolLayers:[{type:"object",anchor:"relative",anchorPosition:{x:0,y:0,z:.5},resource:{primitive:"cube"},material:{color:t.constants.sceneManholeColor}}]};if(e===t.constants.heatPumpLayerName)return{type:"extrude",size:t.state.reportData.heatPumpHight/1e3,material:{color:t.constants.sceneHeatPumpColor},edges:{type:"solid",size:"1px",color:t.constants.sceneHeatPumpOutlineColor}}}getVisualVariables(e){if(e===t.settings.layerNameDrainPipe)return[{type:"size",axis:"height",field:t.settings.fieldName3dGaikeiH,valueUnit:"millimeters"},{type:"size",axis:"width",field:t.settings.fieldName3dGaikeiW,valueUnit:"millimeters"}];if(e===t.settings.layerNameManhole)return[{type:"size",axis:"depth",field:t.settings.fieldName3dGaikeiL,valueUnit:"millimeters"},{type:"size",axis:"height",field:t.settings.fieldName3dDepth,valueUnit:"meters"},{type:"size",axis:"width",field:t.settings.fieldName3dGaikeiS,valueUnit:"millimeters"},{type:"rotation",axis:"heading",rotationType:"arithmetic",field:t.settings.fieldName3dAngle}]}clearSelectedFeatures(){for(let e of this.selectedFeatures)e.highlight.remove();this.selectedFeatures=[]}setFeatureFilter(e){for(let i of this.scene.layers)(i.title===t.settings.layerNameBuildingLod1||i.title===t.settings.layerNameDrainPipe||i.title===t.settings.layerNameManhole)&&(i.definitionExpression=t.settings.fieldNameArea+" = "+e)}initializeEvents(){ne.initialize()}initializeFilter(){if(t.settings.fieldNameAreaNames?.length===0)throw new Error("\u8A2D\u5B9A\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u51E6\u7406\u533A\u304C\u53C2\u7167\u3067\u304D\u307E\u305B\u3093\u3002");let e=t.settings.fieldNameAreaNames[0].Value;this.setFeatureFilter(e)}initializeLayers(){for(let e of this.scene.layers)e.minScale=t.constants.sceneLayerMinScale,e.maxScale=t.constants.SceneLayerMaxScale,e.title!==t.settings.layerNameBuildingLod1&&(e.renderer=this.getRenderer(e.title))}async initialize(){this.graphicCubeLayer=new Te({title:t.constants.heatPumpLayerName,elevationInfo:{mode:"on-the-ground"}}),this.sketchViewModel=null,this.selectedFeatures=[],this.sceneView.highlightOptions.haloOpacity=t.constants.highlightHaloOpacity,this.sceneView.highlightOptions.fillOpacity=t.constants.highlightFillOpacity,this.scene.ground.navigationConstraint={type:"none"},this.scene.ground.opacity=t.constants.sceneGroundOpacity,this.sceneView.popup.autoOpenEnabled=!1,this.initializeLayers(),se.initialize(),this.initializeFilter(),this.initializeEvents()}async init(){var e=new Be;e.authMode="immediate",await e.load();let s={filter:'type:"Web Scene" AND title:"'+"\u516C\u958B\u7528\u30B7\u30FC\u30F3"+'" NOT access:public'},n=await e.queryItems(s);if(n.results.length===0)throw new Error("ArcGIS Online\u304B\u3089\u516C\u958B\u7528\u30B7\u30FC\u30F3\u304C\u53C2\u7167\u3067\u304D\u307E\u305B\u3093\u3002");this.scene=new Me({portalItem:{id:n.results[0].id}}),this.sceneView=new ve({map:this.scene,container:"sceneViewDiv",center:t.settings.center,zoom:t.settings.zoom}),this.scene.when(()=>{this.initialize()})}},h=new K;var[He]=await y(["esri/Graphic"]),q=class{constructor(){}switchView(){let e=document.getElementById("mapDiv"),i=document.getElementById("sceneDiv");this.isMap?(e.classList.add("d-none"),i.classList.remove("d-none"),this.activeSceneEvent(a.mapView.viewpoint)):(e.classList.remove("d-none"),i.classList.add("d-none"),this.activeMapEvent(h.sceneView.viewpoint)),this.isMap=!this.isMap}updateHeatPumpPolygon(e){a.graphicHeatPumpLayer.removeAll(),e.symbol={type:"simple-fill",color:t.constants.sceneHeatPumpColor,style:"solid",outline:{color:t.constants.sceneHeatPumpOutlineColor,width:1}},a.graphicHeatPumpLayer.add(e),t.state.reportData.heatPumpPolygon=e.geometry,f.reset3dHeatPumpPosition()}clearReportData(){t.state.reportData=structuredClone(this.reportDataOrigin)}setFeatureFilters(e){a.setFeatureFilter(e),h.setFeatureFilter(e)}activeMapEvent(e){a.mapView.viewpoint=e,a.endAction()}getQueryFieldNames(e){if(e===t.settings.layerNameBuildingLod1)return["OBJECTID",t.settings.fieldNameBuildingKey];if(e===t.settings.layerNameDrainPipe)return["OBJECTID",t.settings.fieldNameDrainPipeKey]}getSelected2DValue(e){if(e===t.settings.layerNameBuildingLod1)return"'"+t.state.reportData.selectedBuildingKey+"'";if(e===t.settings.layerNameDrainPipe)return t.state.reportData.selectedDrainPipeKey}selectAndHighlight(e){let i=this.getQueryFieldNames(e.title),s=this.getSelected2DValue(e.title),n=e.createQuery();n.outFields=i,n.where=i[1]+" = "+s,e.queryFeatures(n).then(o=>{o.features?.length>0&&h.sceneView.whenLayerView(e).then(function(r){let c=o.features[0],u=r.highlight(c.attributes.OBJECTID);h.selectedFeatures.push({layerName:e.title,graphic:c,highlight:u})})})}activeSceneEvent(e){h.sceneView.viewpoint=e,h.clearSelectedFeatures();for(let i of h.scene.layers)i.title!==t.settings.layerNameBuildingLod1&&i.title!==t.settings.layerNameDrainPipe||this.selectAndHighlight(i)}reset3dHeatPumpPosition(){h.graphicCubeLayer.removeAll();let e={type:"polygon-3d",symbolLayers:h.getSymbol(t.constants.heatPumpLayerName)},i=new He({geometry:t.state.reportData.heatPumpPolygon,symbol:e});h.graphicCubeLayer.add(i)}async init(){this.isMap=!0,this.reportDataOrigin=structuredClone(t.state.reportData),this.switchButton=document.getElementById("switchBtn");let e=this;this.switchButton.addEventListener("click",function(){e.isMap?(this.value="2D",h.sketchViewModel.updateOnGraphicClick=!1):(this.value="3D",h.sketchViewModel.updateOnGraphicClick=!0);let i=document.getElementById("sceneInfoDiv");k(i),e.switchView()})}},f=new q;function oe(l){m("\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F"),console.error("Error occurred: ",l)}window.onerror=oe;window.addEventListener("unhandledrejection",oe);var[Oe,Ce,le]=await y(["esri/portal/Portal","esri/identity/OAuthInfo","esri/identity/IdentityManager"]),re=new Ce({appId,flowType:"auto",popup:!1});le.registerOAuthInfos([re]);try{ze=le.getCredential(re.portalUrl+"/sharing")}catch{window.location.reload()}var ze,j=new Oe;j.authMode="immediate";try{await j.load()}catch{window.location.reload()}if(j.loaded)try{document.getElementById("mapContent").classList.remove("d-none"),E(),await f.init(),await a.init(),await h.init()}finally{S()}
